<!-- saisir_temps_de_cycle.html -->
{% extends 'main.html' %}

{% block title %}Saisir Temps de Cycle{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row mb-1 mt-0">
        <a href="{% url 'admin-menu' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>
    <div id="message" class="mt-3"></div>
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header btn-customer text-white">
                    <h4 class="mb-0">Saisir Temps de Cycle</h4>
                </div>
                <div class="card-body">
                    <form id="tempsDeCycleForm">
                        {% csrf_token %}
                        {{ form.as_p }}
                        <div class="d-grid">
                            <button type="submit" class="btn btn-customer">Enregistrer</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header btn-customer text-white">
                    <h4 class="mb-0">Liste des Temps de Cycle</h4>
                </div>
                <div class="card-body">
                    <ul id="tempsDeCycleList" class="list-group">
                        {% for tdc in temps_de_cycles %}
                        <li class="list-group-item">{{ tdc.produit }} - {{ tdc.face }} - {{ tdc.tcm }}</li>
                        {% endfor %}
                    </ul>
                    {% if temps_de_cycles|length >= 5 %}
                    <button id="loadMore" class="btn btn-customer mt-3">Afficher plus</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
    $(document).ready(function() {
        $('#tempsDeCycleForm').on('submit', function(e) {
            e.preventDefault();
            var formData = $(this).serialize();
            $.ajax({
                type: 'POST',
                url: '{% url "saisir_temps_de_cycle" %}',
                data: formData,
                success: function(response) {
                    $('#message').removeClass('alert-success alert-danger');
                    if (response.success) {
                        $('#message').addClass('alert alert-success').text(response.message);
                        var new_entry = JSON.parse(response.new_entry)[0].fields;
                        $('#tempsDeCycleList').prepend('<li class="list-group-item">' + new_entry.produit + ' - ' + new_entry.face + ' - ' + new_entry.tcm + '</li>');
                        $('#tempsDeCycleForm')[0].reset();
                    } else {
                        $('#message').addClass('alert alert-danger').text(response.message);
                    }
                }
            });
        });

        var offset = 5;
        $('#loadMore').on('click', function() {
            $.ajax({
                type: 'GET',
                url: '{% url "load_more_temps_de_cycles" %}',
                data: {
                    offset: offset
                },
                success: function(response) {
                    var temps_de_cycles = JSON.parse(response.temps_de_cycles);
                    $.each(temps_de_cycles, function(index, tdc) {
                        var fields = tdc.fields;
                        $('#tempsDeCycleList').append('<li class="list-group-item">' + fields.produit + ' - ' + fields.face + ' - ' + fields.tcm + '</li>');
                    });
                    offset += temps_de_cycles.length;
                }
            });
        });
    });
</script>
{% endblock %}
